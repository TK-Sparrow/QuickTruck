<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quick Truck Admin Panel</title>
  <!-- Load Tailwind CSS from CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load Lucide Icons for a clean, modern look -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* Custom styles for the app */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f7f9;
    }

    /* Transform the sidebar for mobile drawer effect */
    #sidebar {
      transition: transform 0.3s ease-in-out;
    }

    .sidebar-open {
      transform: translateX(0) !important;
    }

    /* Active Tab Indicator */
    .tab-active {
      background-color: #1a73e8;
      color: white;
      font-weight: 600;
      border-radius: 9999px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col lg:flex-row text-gray-800">

  <!-- Mobile Menu Button -->
  <button id="mobile-menu-btn" class="lg:hidden fixed top-4 left-4 z-50 p-2 bg-white rounded-full shadow-lg">
    <i data-lucide="menu" class="w-6 h-6 text-gray-700"></i>
  </button>

  <!-- Sidebar / Mobile Drawer Menu -->
  <aside id="sidebar"
    class="fixed inset-y-0 left-0 w-64 bg-white z-40 lg:z-auto shadow-xl lg:shadow-none p-6 transition-transform transform -translate-x-full lg:translate-x-0 lg:flex-shrink-0 flex flex-col">
    <div class="flex items-center mb-10">
      <div class="p-2 bg-blue-600 rounded-full mr-3">
        <i data-lucide="truck" class="w-6 h-6 text-white"></i>
      </div>
      <h1 class="text-2xl font-bold text-gray-900">Quick Truck</h1>
    </div>

    <!-- Navigation Links -->
    <nav class="flex-grow">
      <ul class="space-y-2">
        <li>
          <a href="#" data-tab="dashboard"
            class="tab-link flex items-center p-3 text-gray-600 hover:bg-gray-100 rounded-full transition-colors duration-200">
            <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a href="#" data-tab="bookings"
            class="tab-link flex items-center p-3 text-gray-600 hover:bg-gray-100 rounded-full transition-colors duration-200">
            <i data-lucide="box" class="w-5 h-5 mr-3"></i>
            <span>Bookings</span>
          </a>
        </li>
        <li>
          <a href="#" data-tab="drivers"
            class="tab-link flex items-center p-3 text-gray-600 hover:bg-gray-100 rounded-full transition-colors duration-200">
            <i data-lucide="users-round" class="w-5 h-5 mr-3"></i>
            <span>Drivers</span>
          </a>
        </li>
        <li>
          <a href="#" data-tab="feedback"
            class="tab-link flex items-center p-3 text-gray-600 hover:bg-gray-100 rounded-full transition-colors duration-200">
            <i data-lucide="message-square-text" class="w-5 h-5 mr-3"></i>
            <span>Feedback</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- User Info and Logout -->
    <div class="mt-auto pt-6 border-t border-gray-200">
      <div class="flex items-center justify-between">
        <span id="userIdDisplay" class="text-xs text-gray-500 truncate mr-2"></span>
        <button id="logoutBtn"
          class="flex items-center justify-center p-2 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors duration-200">
          <i data-lucide="log-out" class="w-5 h-5"></i>
        </button>
      </div>
    </div>
  </aside>

  <!-- Main Content Area -->
  <main id="main-content" class="flex-grow p-4 md:p-8 lg:ml-64">
    <!-- Header -->
    <header class="flex justify-between items-center bg-white rounded-xl p-4 md:p-6 shadow-md mb-8">
      <h2 id="page-title" class="text-2xl font-bold text-gray-900">Dashboard</h2>
    </header>

    <!-- Content Sections -->
    <div id="content-container">

      <!-- Dashboard Tab Content -->
      <div id="content-dashboard" class="space-y-8">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6">
          <!-- Metric Card -->
          <div
            class="bg-white rounded-xl p-6 shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-300">
            <div class="p-3 rounded-full bg-blue-100 text-blue-600 mb-3">
              <i data-lucide="box" class="w-8 h-8"></i>
            </div>
            <div id="totalBookings" class="text-4xl font-bold">0</div>
            <div class="text-sm font-medium text-gray-500 mt-1">Total Bookings</div>
          </div>
          <!-- Metric Card -->
          <div
            class="bg-white rounded-xl p-6 shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-300">
            <div class="p-3 rounded-full bg-green-100 text-green-600 mb-3">
              <i data-lucide="users-round" class="w-8 h-8"></i>
            </div>
            <div id="totalDrivers" class="text-4xl font-bold">0</div>
            <div class="text-sm font-medium text-gray-500 mt-1">Total Drivers</div>
          </div>
          <!-- Metric Card -->
          <div
            class="bg-white rounded-xl p-6 shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-300">
            <div class="p-3 rounded-full bg-teal-100 text-teal-600 mb-3">
              <i data-lucide="badge-check" class="w-8 h-8"></i>
            </div>
            <div id="completedBookings" class="text-4xl font-bold">0</div>
            <div class="text-sm font-medium text-gray-500 mt-1">Completed Bookings</div>
          </div>
          <!-- Metric Card -->
          <div
            class="bg-white rounded-xl p-6 shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-300">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mb-3">
              <i data-lucide="hourglass" class="w-8 h-8"></i>
            </div>
            <div id="pendingBookings" class="text-4xl font-bold">0</div>
            <div class="text-sm font-medium text-gray-500 mt-1">Pending Bookings</div>
          </div>
          <!-- Metric Card -->
          <div
            class="bg-white rounded-xl p-6 shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-300">
            <div class="p-3 rounded-full bg-indigo-100 text-indigo-600 mb-3">
              <i data-lucide="truck" class="w-8 h-8"></i>
            </div>
            <div id="idleDrivers" class="text-4xl font-bold">0</div>
            <div class="text-sm font-medium text-gray-500 mt-1">Idle Drivers</div>
          </div>
          <!-- Metric Card -->
          <div
            class="bg-white rounded-xl p-6 shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-300">
            <div class="p-3 rounded-full bg-purple-100 text-purple-600 mb-3">
              <i data-lucide="dollar-sign" class="w-8 h-8"></i>
            </div>
            <div id="totalRevenue" class="text-4xl font-bold">$0</div>
            <div class="text-sm font-medium text-gray-500 mt-1">Total Revenue</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Recent Bookings Widget -->
          <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-xl font-bold mb-4">Recent Bookings</h3>
            <ul id="recentBookingsList" class="space-y-3">
              <!-- Recent bookings will be dynamically inserted here -->
            </ul>
          </div>

          <!-- Recent Feedback Widget -->
          <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-xl font-bold mb-4">Recent Feedback</h3>
            <ul id="recentFeedbackList" class="space-y-3">
              <!-- Recent feedback will be dynamically inserted here -->
            </ul>
          </div>
        </div>
      </div>

      <!-- Bookings Tab Content -->
      <div id="content-bookings" class="hidden">
        <div class="mb-6 flex flex-wrap gap-2">
          <button class="filter-bookings-btn px-4 py-2 text-sm rounded-full transition-colors duration-200"
            data-status="all">All</button>
          <button class="filter-bookings-btn px-4 py-2 text-sm rounded-full transition-colors duration-200"
            data-status="pending">Pending</button>
          <button class="filter-bookings-btn px-4 py-2 text-sm rounded-full transition-colors duration-200"
            data-status="accepted">Accepted</button>
          <button class="filter-bookings-btn px-4 py-2 text-sm rounded-full transition-colors duration-200"
            data-status="completed">Completed</button>
          <button class="filter-bookings-btn px-4 py-2 text-sm rounded-full transition-colors duration-200"
            data-status="cancelled">Cancelled</button>
        </div>

        <!-- Mobile Card View for Bookings -->
        <div id="bookingsMobileList" class="lg:hidden space-y-4">
          <!-- Booking cards will be dynamically inserted here -->
        </div>

        <!-- Desktop Table View for Bookings -->
        <div class="hidden lg:block overflow-x-auto bg-white rounded-xl shadow-md">
          <table class="min-w-full">
            <thead>
              <tr class="text-gray-600 uppercase text-xs leading-normal bg-gray-50">
                <th class="py-3 px-6 text-left">Booking ID</th>
                <th class="py-3 px-6 text-left">From</th>
                <th class="py-3 px-6 text-left">To</th>
                <th class="py-3 px-6 text-left">Status</th>
                <th class="py-3 px-6 text-left">Customer</th>
                <th class="py-3 px-6 text-left">Driver</th>
                <th class="py-3 px-6 text-left">Fare</th>
                <th class="py-3 px-6 text-left">Date</th>
                <th class="py-3 px-6 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="bookingsTableBody" class="text-sm font-light">
              <!-- Booking rows will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Drivers Tab Content -->
      <div id="content-drivers" class="hidden">
        <div class="mb-6 flex flex-wrap gap-2">
          <button class="filter-drivers-btn px-4 py-2 text-sm rounded-full transition-colors duration-200"
            data-status="all">All</button>
          <button class="filter-drivers-btn px-4 py-2 text-sm rounded-full transition-colors duration-200"
            data-status="pending">Pending</button>
          <button class="filter-drivers-btn px-4 py-2 text-sm rounded-full transition-colors duration-200"
            data-status="accepted">Accepted</button>
          <button class="filter-drivers-btn px-4 py-2 text-sm rounded-full transition-colors duration-200"
            data-status="rejected">Rejected</button>
        </div>

        <!-- Mobile Card View for Drivers -->
        <div id="driversMobileList" class="lg:hidden space-y-4">
          <!-- Driver cards will be dynamically inserted here -->
        </div>

        <!-- Desktop Table View for Drivers -->
        <div class="hidden lg:block overflow-x-auto bg-white rounded-xl shadow-md">
          <table class="min-w-full">
            <thead>
              <tr class="text-gray-600 uppercase text-xs leading-normal bg-gray-50">
                <th class="py-3 px-6 text-left">Driver Name</th>
                <th class="py-3 px-6 text-left">Status</th>
                <th class="py-3 px-6 text-left">Truck Type</th>
                <th class="py-3 px-6 text-left">Phone</th>
                <th class="py-3 px-6 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="driversTableBody" class="text-sm font-light">
              <!-- Driver rows will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Feedback Tab Content -->
      <div id="content-feedback" class="hidden">
        <!-- Mobile Card View for Feedback -->
        <div id="feedbackMobileList" class="lg:hidden space-y-4">
          <!-- Feedback cards will be dynamically inserted here -->
        </div>

        <!-- Desktop Table View for Feedback -->
        <div class="hidden lg:block overflow-x-auto bg-white rounded-xl shadow-md">
          <table class="min-w-full">
            <thead>
              <tr class="text-gray-600 uppercase text-xs leading-normal bg-gray-50">
                <th class="py-3 px-6 text-left">Name</th>
                <th class="py-3 px-6 text-left">Email</th>
                <th class="py-3 px-6 text-left">Feedback</th>
                <th class="py-3 px-6 text-left">Date</th>
              </tr>
            </thead>
            <tbody id="feedbackTableBody" class="text-sm font-light">
              <!-- Feedback rows will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Custom Modal/Dialog for actions -->
  <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-50"
    aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div
      class="relative bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transition-transform transform scale-95 duration-200">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-900" id="modal-title"></h3>
        <button data-dismiss="modal" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div id="modal-body" class="text-sm text-gray-700 mb-6">
        <!-- Modal content will be dynamically inserted here -->
      </div>
      <div id="modal-footer" class="flex justify-end space-x-2">
        <!-- Modal buttons will be dynamically inserted here -->
      </div>
    </div>
  </div>


  <!-- Firebase SDK imports -->
  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInAnonymously,
      signInWithCustomToken,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getDatabase,
      ref,
      onValue,
      update,
      get,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // IMPORTANT: The `__firebase_config` and `__app_id` variables are provided by the hosting environment.
    // They are crucial for connecting to the correct Firebase project and should not be modified.
    const __firebase_config = "{\"apiKey\":\"AIzaSyDyqN2xmtJwsnhqfQfNeuMtnZ3sjb7nnMw\",\"authDomain\":\"quick-truck-66fb0.firebaseapp.com\",\"projectId\":\"quick-truck-66fb0\",\"storageBucket\":\"quick-truck-66fb0.firebasestorage.app\",\"messagingSenderId\":\"477852731829\",\"appId\":\"1:477852731829:web:e9e143a0bf49ae8e8f71fc\"}";
    let __app_id = "1:477852731829:web:e9e143a0bf49ae8e8f71fc";

    // Global variables for Firebase access provided by the environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      projectId: "quick-truck"
    };
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Initialize Firebase app and services
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    let userId = null;

    // UI elements
    const mainContent = document.getElementById('main-content');
    const pageTitle = document.getElementById('page-title');
    const tabLinks = document.querySelectorAll('.tab-link');
    const contentContainer = document.getElementById('content-container');
    const contentDashboard = document.getElementById('content-dashboard');
    const contentBookings = document.getElementById('content-bookings');
    const contentDrivers = document.getElementById('content-drivers');
    const contentFeedback = document.getElementById('content-feedback');
    const driversTableBody = document.getElementById('driversTableBody');
    const bookingsTableBody = document.getElementById('bookingsTableBody');
    const feedbackTableBody = document.getElementById('feedbackTableBody');
    const driversMobileList = document.getElementById('driversMobileList');
    const bookingsMobileList = document.getElementById('bookingsMobileList');
    const feedbackMobileList = document.getElementById('feedbackMobileList');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const logoutBtn = document.getElementById('logoutBtn');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalFooter = document.getElementById('modal-footer');
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const sidebar = document.getElementById('sidebar');

    // Dashboard metric elements
    const totalBookingsEl = document.getElementById('totalBookings');
    const totalDriversEl = document.getElementById('totalDrivers');
    const completedBookingsEl = document.getElementById('completedBookings');
    const pendingBookingsEl = document.getElementById('pendingBookings');
    const idleDriversEl = document.getElementById('idleDrivers');
    const totalRevenueEl = document.getElementById('totalRevenue');
    const recentBookingsList = document.getElementById('recentBookingsList');
    const recentFeedbackList = document.getElementById('recentFeedbackList');

    // Store fetched data globally for filtering and UI state
    let allDriversData = {};
    let allBookingsData = {};
    let allFeedbackData = {};
    let lastDriverFilterStatus = 'all'; // Default filter for drivers
    let lastBookingFilterStatus = 'all'; // Default filter for bookings

    // --- Firebase Authentication and Initialization ---
    // This function handles the authentication and subsequent data fetching.
    const setupApp = async () => {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
          console.log("Firebase custom token sign-in successful.");
        } else {
          await signInAnonymously(auth);
          console.log("Firebase anonymous sign-in successful.");
        }
      } catch (customTokenError) {
        console.error("Firebase custom token sign-in failed:", customTokenError);
        console.log("Falling back to anonymous sign-in...");
        try {
          await signInAnonymously(auth);
          console.log("Firebase anonymous sign-in successful.");
        } catch (anonymousError) {
          console.error("Firebase anonymous sign-in failed:", anonymousError);
        }
      }
    };

    // --- UI and Data Rendering Functions ---
    // Shows a custom modal dialog
    const showModal = (title, bodyHtml, footerHtml) => {
      modalTitle.innerHTML = title;
      modalBody.innerHTML = bodyHtml;
      modalFooter.innerHTML = footerHtml;
      modal.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
    };

    // Closes the modal dialog
    const closeModal = () => {
      modal.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
    };

    // Renders the dashboard with the latest data
    const renderDashboard = () => {
      // Calculate metrics
      const totalBookingsCount = Object.keys(allBookingsData).length;
      const acceptedDriversCount = Object.values(allDriversData).filter(d => d.status !== 'pending' && d.status !== 'rejected').length;
      const completedBookingsCount = Object.values(allBookingsData).filter(b => b.status === 'completed').length;
      const pendingBookingsCount = Object.values(allBookingsData).filter(b => b.status === 'pending' || !b.status).length;
      const idleDriversCount = Object.values(allDriversData).filter(d => d.status === 'idle' || d.status === 'available').length;
      const totalRevenue = Object.values(allBookingsData)
        .filter(b => b.status === 'completed' && b.fare)
        .reduce((sum, b) => sum + (parseFloat(b.fare) || 0), 0);

      // Update card elements
      totalBookingsEl.textContent = totalBookingsCount;
      totalDriversEl.textContent = acceptedDriversCount;
      completedBookingsEl.textContent = completedBookingsCount;
      pendingBookingsEl.textContent = pendingBookingsCount;
      idleDriversEl.textContent = idleDriversCount;
      totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;

      // Render recent activity lists
      renderRecentBookings();
      renderRecentFeedback();
      lucide.createIcons();
    };

    // Renders the recent bookings list
    const renderRecentBookings = () => {
      recentBookingsList.innerHTML = '';
      const recentBookings = Object.entries(allBookingsData)
        .sort(([keyA], [keyB]) => keyB.localeCompare(keyA))
        .slice(0, 5);

      if (recentBookings.length === 0) {
        recentBookingsList.innerHTML = `<li class="text-gray-500 italic text-center">No recent bookings.</li>`;
        return;
      }

      recentBookings.forEach(([bookingId, booking]) => {
        const li = document.createElement('li');
        li.className = 'bg-gray-50 p-3 rounded-xl flex items-center justify-between transition-colors hover:bg-gray-100';
        li.innerHTML = `
          <div>
            <span class="font-semibold text-gray-800">${booking.name}</span>
            <p class="text-xs text-gray-500">${booking.pickup} to ${booking.delivery}</p>
          </div>
          <div class="text-right">
            <span class="text-xs font-medium text-blue-600">${booking.status || 'pending'}</span>
            <p class="text-xs text-gray-400">#${bookingId.substring(0, 5)}...</p>
          </div>
        `;
        recentBookingsList.appendChild(li);
      });
    };

    // Renders the recent feedback list
    const renderRecentFeedback = () => {
      recentFeedbackList.innerHTML = '';
      const recentFeedback = Object.entries(allFeedbackData)
        .sort(([keyA], [keyB]) => keyB.localeCompare(keyA))
        .slice(0, 5);

      if (recentFeedback.length === 0) {
        recentFeedbackList.innerHTML = `<li class="text-gray-500 italic text-center">No recent feedback.</li>`;
        return;
      }

      recentFeedback.forEach(([feedbackId, feedback]) => {
        const li = document.createElement('li');
        li.className = 'bg-gray-50 p-3 rounded-xl transition-colors hover:bg-gray-100';
        const timestamp = new Date(parseInt(feedbackId));
        const formattedDate = timestamp.toLocaleString();
        li.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-semibold text-gray-800">${feedback.name || 'Anonymous'}</span>
            <span class="text-xs text-gray-400">${formattedDate}</span>
          </div>
          <p class="text-sm text-gray-600 line-clamp-2">${feedback.feedback}</p>
        `;
        recentFeedbackList.appendChild(li);
      });
    };

    // Updates the styling of filter buttons for drivers
    const updateDriverFilterButtonStyles = (activeStatus) => {
      document.querySelectorAll('.filter-drivers-btn').forEach(btn => {
        if (btn.dataset.status === activeStatus) {
          btn.classList.add('bg-blue-600', 'text-white');
          btn.classList.remove('bg-gray-200', 'text-gray-700');
        } else {
          btn.classList.add('bg-gray-200', 'text-gray-700');
          btn.classList.remove('bg-blue-600', 'text-white');
        }
      });
    };

    // Updates the styling of filter buttons for bookings
    const updateBookingFilterButtonStyles = (activeStatus) => {
      document.querySelectorAll('.filter-bookings-btn').forEach(btn => {
        if (btn.dataset.status === activeStatus) {
          btn.classList.add('bg-blue-600', 'text-white');
          btn.classList.remove('bg-gray-200', 'text-gray-700');
        } else {
          btn.classList.add('bg-gray-200', 'text-gray-700');
          btn.classList.remove('bg-blue-600', 'text-white');
        }
      });
    };

    // Renders a single driver table row
    const createDriverRow = (driver, driverId) => {
      const row = document.createElement('tr');
      row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-colors duration-150';
      const driverStatus = driver.status || 'pending';
      let statusColor = 'bg-gray-200 text-gray-700';
      if (driverStatus === 'idle' || driverStatus === 'available') statusColor = 'bg-green-100 text-green-600';
      if (driverStatus === 'busy') statusColor = 'bg-yellow-100 text-yellow-600';
      if (driverStatus === 'pending') statusColor = 'bg-blue-100 text-blue-600';
      if (driverStatus === 'rejected') statusColor = 'bg-red-100 text-red-600';

      let buttonsHtml = '';
      if (driverStatus === 'pending') {
        buttonsHtml = `
          <button data-id="${driverId}" class="accept-driver-btn bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded-full text-xs transition duration-300 mr-1">Accept</button>
          <button data-id="${driverId}" class="reject-driver-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-full text-xs transition duration-300">Reject</button>
        `;
      } else if (driverStatus === 'rejected') {
        buttonsHtml = `
          <button data-id="${driverId}" class="accept-rejected-driver-btn bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded-full text-xs transition duration-300">Accept Back</button>
        `;
      } else { // Accepted, idle, busy, available
        const toggleBtnText = (driverStatus === 'idle' || driverStatus === 'available') ? 'Mark Busy' : 'Mark Idle';
        const toggleBtnColor = (driverStatus === 'idle' || driverStatus === 'available') ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-blue-500 hover:bg-blue-600';
        buttonsHtml = `
          <button data-id="${driverId}" data-status="${driverStatus}" class="toggle-driver-status-btn font-semibold py-1 px-3 rounded-full text-xs transition duration-300 ${toggleBtnColor} text-white mr-1">${toggleBtnText}</button>
          <button data-id="${driverId}" class="reject-accepted-driver-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-full text-xs transition duration-300">Reject</button>
        `;
      }

      row.innerHTML = `
        <td class="py-3 px-6 whitespace-nowrap">${driver.driverName}</td>
        <td class="py-3 px-6"><span class="font-medium text-xs px-2 py-1 rounded-full ${statusColor}">${driverStatus}</span></td>
        <td class="py-3 px-6 whitespace-nowrap">${driver.truckType}</td>
        <td class="py-3 px-6 whitespace-nowrap">${driver.phone}</td>
        <td class="py-3 px-6 flex flex-wrap gap-1">${buttonsHtml}</td>
      `;
      return row;
    };

    // Renders a single driver mobile card
    const createDriverCard = (driver, driverId) => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow-md p-4 space-y-2 transition-transform hover:scale-[1.02] duration-300';
      const driverStatus = driver.status || 'pending';
      let statusColor = 'bg-gray-200 text-gray-700';
      if (driverStatus === 'idle' || driverStatus === 'available') statusColor = 'bg-green-100 text-green-600';
      if (driverStatus === 'busy') statusColor = 'bg-yellow-100 text-yellow-600';
      if (driverStatus === 'pending') statusColor = 'bg-blue-100 text-blue-600';
      if (driverStatus === 'rejected') statusColor = 'bg-red-100 text-red-600';

      let buttonsHtml = '';
      if (driverStatus === 'pending') {
        buttonsHtml = `
          <button data-id="${driverId}" class="accept-driver-btn w-1/2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-full text-sm transition duration-300">Accept</button>
          <button data-id="${driverId}" class="reject-driver-btn w-1/2 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-full text-sm transition duration-300">Reject</button>
        `;
      } else if (driverStatus === 'rejected') {
        buttonsHtml = `
          <button data-id="${driverId}" class="accept-rejected-driver-btn w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-full text-sm transition duration-300">Accept Back</button>
        `;
      } else { // Accepted, idle, busy, available
        const toggleBtnText = (driverStatus === 'idle' || driverStatus === 'available') ? 'Mark Busy' : 'Mark Idle';
        const toggleBtnColor = (driverStatus === 'idle' || driverStatus === 'available') ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-blue-500 hover:bg-blue-600';
        buttonsHtml = `
          <button data-id="${driverId}" data-status="${driverStatus}" class="toggle-driver-status-btn w-1/2 font-semibold py-2 rounded-full text-sm transition duration-300 ${toggleBtnColor} text-white">
            ${toggleBtnText}
          </button>
          <button data-id="${driverId}" class="reject-accepted-driver-btn w-1/2 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-full text-sm transition duration-300">Reject</button>
        `;
      }

      card.innerHTML = `
        <div class="flex items-center justify-between">
            <span class="font-bold text-lg">${driver.driverName}</span>
            <span class="font-medium text-xs px-2 py-1 rounded-full ${statusColor}">${driverStatus}</span>
        </div>
        <div class="text-sm text-gray-600 space-y-1">
            <p><span class="font-semibold">Truck Type:</span> ${driver.truckType}</p>
            <p><span class="font-semibold">Phone:</span> ${driver.phone}</p>
        </div>
        <div class="flex justify-between space-x-2 mt-4">
          ${buttonsHtml}
        </div>
      `;
      return card;
    };

    // Renders a single booking table row with the new design and action buttons
    const createBookingRow = (booking, bookingId) => {
      const row = document.createElement('tr');
      row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-colors duration-150 cursor-pointer';
      row.dataset.id = bookingId;

      const bookingStatus = booking.status || 'pending';
      const driverName = booking.assignedDriverName || 'Unassigned';
      const fare = booking.fare ? `$${parseFloat(booking.fare).toFixed(2)}` : 'N/A';
      let deliveryDate = 'N/A';
      let deliveryTime = 'N/A';

      if (booking.datetime) {
        [deliveryDate, deliveryTime] = booking.datetime.split('T');
      }

      let statusColor = 'bg-gray-200 text-gray-700';
      if (bookingStatus === 'completed') statusColor = 'bg-green-100 text-green-600';
      if (bookingStatus === 'accepted') statusColor = 'bg-yellow-100 text-yellow-600';
      if (bookingStatus === 'pending') statusColor = 'bg-blue-100 text-blue-600';
      if (bookingStatus === 'cancelled') statusColor = 'bg-red-100 text-red-600';

      let actionButtonsHtml = '';
      if (bookingStatus === 'pending') {
        actionButtonsHtml = `
            <button data-id="${bookingId}" class="accept-booking-btn bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded-full text-xs transition duration-300">Accept</button>
            <button data-id="${bookingId}" class="cancel-booking-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-full text-xs transition duration-300">Cancel</button>
          `;
      } else if (bookingStatus === 'accepted') {
        actionButtonsHtml = `
            <button data-id="${bookingId}" class="complete-booking-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-full text-xs transition duration-300">Complete</button>
            <button data-id="${bookingId}" class="cancel-booking-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-full text-xs transition duration-300">Cancel</button>
          `;
      } else {
        actionButtonsHtml = `<span class="text-xs text-gray-400">No actions</span>`;
      }

      row.innerHTML = `
        <td class="py-3 px-6 whitespace-nowrap text-xs text-gray-500 font-mono">${bookingId}</td>
        <td class="py-3 px-6 whitespace-nowrap">${booking.pickup}</td>
        <td class="py-3 px-6 whitespace-nowrap">${booking.delivery}</td>
        <td class="py-3 px-6"><span class="font-medium text-xs px-2 py-1 rounded-full ${statusColor}">${bookingStatus}</span></td>
        <td class="py-3 px-6 whitespace-nowrap">${booking.name}</td>
        <td class="py-3 px-6 whitespace-nowrap">${driverName}</td>
        <td class="py-3 px-6 whitespace-nowrap">${fare}</td>
        <td class="py-3 px-6 whitespace-nowrap">${deliveryDate}</td>
        <td class="py-3 px-6 flex flex-wrap gap-1">${actionButtonsHtml}</td>
      `;
      return row;
    };

    // Renders a single booking mobile card with the new design and action buttons
    const createBookingCard = (booking, bookingId) => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow-md p-4 space-y-2 relative transition-transform hover:scale-[1.02] duration-300';
      card.dataset.id = bookingId;

      const bookingStatus = booking.status || 'pending';
      const driverName = booking.assignedDriverName || 'Unassigned';
      const fare = booking.fare ? `$${parseFloat(booking.fare).toFixed(2)}` : 'N/A';
      const datetime = booking.datetime ? new Date(booking.datetime).toLocaleString() : 'N/A';
      let statusColor = 'bg-gray-200 text-gray-700';
      if (bookingStatus === 'completed') statusColor = 'bg-green-100 text-green-600';
      if (bookingStatus === 'accepted') statusColor = 'bg-yellow-100 text-yellow-600';
      if (bookingStatus === 'pending') statusColor = 'bg-blue-100 text-blue-600';
      if (bookingStatus === 'cancelled') statusColor = 'bg-red-100 text-red-600';


      let actionButtonsHtml = '';
      if (bookingStatus === 'pending') {
        actionButtonsHtml = `
            <button data-id="${bookingId}" class="accept-booking-btn w-1/2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-full text-sm transition duration-300">Accept</button>
            <button data-id="${bookingId}" class="cancel-booking-btn w-1/2 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-full text-sm transition duration-300">Cancel</button>
          `;
      } else if (bookingStatus === 'accepted') {
        actionButtonsHtml = `
            <button data-id="${bookingId}" class="complete-booking-btn w-1/2 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-full text-sm transition duration-300">Complete</button>
            <button data-id="${bookingId}" class="cancel-booking-btn w-1/2 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-full text-sm transition duration-300">Cancel</button>
          `;
      } else {
        actionButtonsHtml = `<span class="text-sm text-gray-400 italic">No actions available</span>`;
      }

      card.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="text-sm text-gray-500 font-mono">#${bookingId.substring(0, 8)}...</span>
          <span class="font-medium text-xs px-2 py-1 rounded-full ${statusColor}">${bookingStatus}</span>
        </div>
        <div class="flex items-center text-lg font-bold text-gray-800">
          <span>${booking.pickup}</span>
          <i data-lucide="arrow-right" class="inline-block w-4 h-4 mx-2"></i>
          <span>${booking.delivery}</span>
        </div>
        <div class="text-sm text-gray-600 space-y-1">
          <p><span class="font-semibold">Customer:</span> ${booking.name}</p>
          <p><span class="font-semibold">Driver:</span> ${driverName}</p>
          <p><span class="font-semibold">Fare:</span> ${fare}</p>
          <p><span class="font-semibold">Date:</span> ${datetime}</p>
        </div>
        <div class="flex justify-between space-x-2 mt-4">
          ${actionButtonsHtml}
        </div>
      `;
      return card;
    };


    // Renders a single feedback table row
    const createFeedbackRow = (feedback, feedbackId) => {
      const row = document.createElement('tr');
      row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-colors duration-150';
      const timestamp = new Date(parseInt(feedbackId));
      const formattedDate = timestamp.toLocaleString();
      row.innerHTML = `
        <td class="py-3 px-6 whitespace-nowrap">${feedback.name || 'N/A'}</td>
        <td class="py-3 px-6 whitespace-nowrap">${feedback.email || 'N/A'}</td>
        <td class="py-3 px-6 whitespace-normal">${feedback.feedback || 'N/A'}</td>
        <td class="py-3 px-6 whitespace-nowrap">${formattedDate}</td>
      `;
      return row;
    };

    // Renders a single feedback mobile card
    const createFeedbackCard = (feedback, feedbackId) => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow-md p-4 space-y-2 transition-transform hover:scale-[1.02] duration-300';

      const timestamp = new Date(parseInt(feedbackId));
      const formattedDate = timestamp.toLocaleString();

      card.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="font-bold text-gray-800">${feedback.name || 'Anonymous'}</span>
          <span class="text-sm text-gray-500">${formattedDate}</span>
        </div>
        <div class="text-sm text-gray-600 mt-2">
          <p class="font-semibold">Email: ${feedback.email || 'N/A'}</p>
          <p class="mt-2 text-gray-700 line-clamp-3">${feedback.feedback}</p>
        </div>
      `;
      return card;
    };

    // Filters and renders the drivers table/cards based on status
    const filterDrivers = (status) => {
      driversTableBody.innerHTML = '';
      driversMobileList.innerHTML = '';
      Object.entries(allDriversData).forEach(([driverId, driver]) => {
        const driverStatus = driver.status || 'pending';
        if (status === 'all' || driverStatus === status || (status === 'accepted' && driverStatus !== 'pending' && driverStatus !== 'rejected')) {
          driversTableBody.appendChild(createDriverRow(driver, driverId));
          driversMobileList.appendChild(createDriverCard(driver, driverId));
        }
      });
      attachDriverEventListeners();
      lucide.createIcons();
    };

    // Filters and renders the bookings table/cards based on status
    const filterBookings = (status) => {
      bookingsTableBody.innerHTML = '';
      bookingsMobileList.innerHTML = '';
      Object.entries(allBookingsData).forEach(([bookingId, booking]) => {
        const bookingStatus = booking.status || 'pending';
        if (status === 'all' || bookingStatus === status || (status === 'accepted' && bookingStatus === 'accepted')) {
          bookingsTableBody.appendChild(createBookingRow(booking, bookingId));
          bookingsMobileList.appendChild(createBookingCard(booking, bookingId));
        }
      });
      attachBookingEventListeners();
      lucide.createIcons();
    };

    // Renders the feedback table/cards
    const renderFeedback = () => {
      feedbackTableBody.innerHTML = '';
      feedbackMobileList.innerHTML = '';
      Object.entries(allFeedbackData).forEach(([feedbackId, feedback]) => {
        feedbackTableBody.appendChild(createFeedbackRow(feedback, feedbackId));
        feedbackMobileList.appendChild(createFeedbackCard(feedback, feedbackId));
      });
      lucide.createIcons();
    };


    // --- Realtime Database Data Fetching and Real-time Listeners ---
    // Fetches and displays drivers in real-time
    const fetchDrivers = async () => {
      const driversRef = ref(db, `/artifacts/${appId}/public/data/drivers`);

      onValue(driversRef, (snapshot) => {
        allDriversData = snapshot.val() || {};
        // Use the last stored filter status
        filterDrivers(lastDriverFilterStatus);
        renderDashboard();
      });
    };

    // Fetches and displays bookings in real-time
    const fetchBookings = async () => {
      const bookingsRef = ref(db, `/artifacts/${appId}/public/data/bookings`);

      onValue(bookingsRef, (snapshot) => {
        allBookingsData = snapshot.val() || {};
        // Use the last stored filter status
        filterBookings(lastBookingFilterStatus);
        renderDashboard();
      });
    };

    // Fetches and displays feedback in real-time
    const fetchFeedback = async () => {
      const feedbackRef = ref(db, `/artifacts/${appId}/public/data/feedback`);
      onValue(feedbackRef, (snapshot) => {
        allFeedbackData = snapshot.val() || {};
        renderFeedback();
      });
    };


    // --- Realtime Database Action Handlers ---
    // Updates a driver's status
    const updateDriverStatus = async (driverId, newStatus) => {
      try {
        const driverRef = ref(db, `/artifacts/${appId}/public/data/drivers/${driverId}`);
        await update(driverRef, {
          status: newStatus
        });
        closeModal();
      } catch (e) {
        console.error("Error updating driver status: ", e);
      }
    };

    // Updates a booking's status
    const updateBookingStatus = async (bookingId, newStatus, assignedDriverId = null, fare = null, assignedDriverName = null) => {
      try {
        const bookingRef = ref(db, `/artifacts/${appId}/public/data/bookings/${bookingId}`);
        const updates = {
          status: newStatus
        };
        if (assignedDriverId) updates.assignedDriverId = assignedDriverId;
        if (assignedDriverName) updates.assignedDriverName = assignedDriverName;
        if (fare) updates.fare = fare;
        if (newStatus === 'completed') {
          updates.completionTime = serverTimestamp();
        } else if (newStatus === 'accepted' || newStatus === 'cancelled') {
          updates.completionTime = null;
        }
        await update(bookingRef, updates);
        closeModal();
      } catch (e) {
        console.error("Error updating booking status: ", e);
      }
    };


    // --- UI Event Listeners and Logic ---
    const attachDriverEventListeners = () => {
      // Event listeners for driver actions
      document.querySelectorAll('.accept-driver-btn').forEach(button => {
        button.onclick = () => updateDriverStatus(button.dataset.id, 'idle');
      });
      document.querySelectorAll('.reject-driver-btn').forEach(button => {
        button.onclick = () => updateDriverStatus(button.dataset.id, 'rejected');
      });
      // New event listener for accepting rejected drivers
      document.querySelectorAll('.accept-rejected-driver-btn').forEach(button => {
        button.onclick = () => updateDriverStatus(button.dataset.id, 'idle');
      });
      // New event listener for rejecting accepted drivers
      document.querySelectorAll('.reject-accepted-driver-btn').forEach(button => {
        button.onclick = () => updateDriverStatus(button.dataset.id, 'rejected');
      });
      document.querySelectorAll('.toggle-driver-status-btn').forEach(button => {
        button.onclick = () => {
          const newStatus = button.dataset.status === 'idle' || button.dataset.status === 'available' ? 'busy' : 'idle';
          updateDriverStatus(button.dataset.id, newStatus);
        };
      });
    };

    const attachBookingEventListeners = () => {
      const bookingContainer = document.getElementById('content-bookings');

      // Event delegation for booking row clicks to show details (desktop)
      bookingContainer.addEventListener('click', (event) => {
        // Find the closest row (tr) element or card div
        const target = event.target;
        let element = target.closest('tr') || target.closest('.bg-white.rounded-xl.shadow-md.p-4');

        if (!element) return;

        // Check if the click was on a button. If so, don't show the full details modal.
        if (target.closest('button')) {
          return;
        }

        const bookingId = element.dataset.id;
        const booking = allBookingsData[bookingId];

        if (booking) {
          let deliveryDate = 'N/A';
          let deliveryTime = 'N/A';
          if (booking.datetime) {
            [deliveryDate, deliveryTime] = booking.datetime.split('T');
          }
          const detailsHtml = `
                  <div class="space-y-4 text-left">
                      <p><span class="font-semibold">Booking ID:</span> <span class="font-mono text-xs">${bookingId}</span></p>
                      <p><span class="font-semibold">Status:</span> <span class="font-medium text-blue-600">${booking.status || 'N/A'}</span></p>
                      <p><span class="font-semibold">Customer Name:</span> ${booking.name || 'N/A'}</p>
                      <p><span class="font-semibold">Customer Phone:</span> ${booking.phone || 'N/A'}</p>
                      <p><span class="font-semibold">Customer Email:</span> ${booking.email || 'N/A'}</p>
                      <p><span class="font-semibold">Pickup Location:</span> ${booking.pickup || 'N/A'}</p>
                      <p><span class="font-semibold">Delivery Location:</span> ${booking.delivery || 'N/A'}</p>
                      <p><span class="font-semibold">Delivery Date:</span> ${deliveryDate}</p>
                      <p><span class="font-semibold">Delivery Time:</span> ${deliveryTime}</p>
                      <p><span class="font-semibold">Cargo Description:</span> ${booking.cargoDescription || 'N/A'}</p>
                      <p><span class="font-semibold">Special Instructions:</span> ${booking.specialInstructions || 'N/A'}</p>
                      <p><span class="font-semibold">Assigned Driver:</span> ${booking.assignedDriverName || 'Unassigned'}</p>
                      <p><span class="font-semibold">Fare:</span> ${booking.fare ? `$${parseFloat(booking.fare).toFixed(2)}` : 'N/A'}</p>
                  </div>
              `;
          showModal('Booking Details', detailsHtml,
            `<button data-dismiss="modal" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-full transition duration-300">Close</button>`
          );
        }
      });


      // Event listeners for booking actions
      document.querySelectorAll('.accept-booking-btn').forEach(button => {
        button.onclick = async (event) => {
          event.stopPropagation();
          const bookingId = event.currentTarget.dataset.id;
          const idleDrivers = await getIdleDrivers();

          if (idleDrivers.length === 0) {
            showModal('No Idle Drivers', '<p class="text-gray-700">There are currently no idle drivers available to assign. Please accept a new driver or wait for an existing one to become idle.</p>',
              `<button data-dismiss="modal" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition duration-300">OK</button>`
            );
            return;
          }

          const driverOptionsHtml = idleDrivers.map(driver => `<option value="${driver.id}">${driver.name}</option>`).join('');

          showModal('Accept Booking & Assign Driver',
            `<div class="mt-4 space-y-4 text-left">
                  <label class="block text-sm font-semibold text-gray-700">Set Fare:</label>
                  <input type="number" id="fareInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Enter fare amount" required>
                  <label class="block text-sm font-semibold text-gray-700">Assign Driver:</label>
                  <select id="driverSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                  ${driverOptionsHtml}
                  </select>
              </div>`,
            `<button id="confirmAcceptBooking" data-id="${bookingId}" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-full transition duration-300">Confirm</button>
              <button data-dismiss="modal" class="ml-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition duration-300">Cancel</button>`
          );

          document.getElementById('confirmAcceptBooking').onclick = () => {
            const fare = document.getElementById('fareInput').value;
            const driverSelect = document.getElementById('driverSelect');
            const assignedDriverId = driverSelect.value;
            const assignedDriverName = driverSelect.options[driverSelect.selectedIndex].text;
            if (fare && assignedDriverId) {
              updateBookingStatus(bookingId, 'accepted', assignedDriverId, fare, assignedDriverName);
              updateDriverStatus(assignedDriverId, 'busy');
            } else {
              showModal('Error', '<p class="text-red-600">Please enter a fare and select a driver.</p>',
                `<button data-dismiss="modal" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition duration-300">OK</button>`
              );
            }
          };
        };
      });

      document.querySelectorAll('.cancel-booking-btn').forEach(button => {
        button.onclick = (event) => {
          event.stopPropagation();
          const bookingId = event.currentTarget.dataset.id;
          showModal('Confirm Cancellation', `<p class="text-gray-700">Are you sure you want to cancel this booking? This action cannot be undone.</p>`,
            `<button id="confirmCancelBooking" data-id="${bookingId}" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full transition duration-300">Yes, Cancel</button>
             <button data-dismiss="modal" class="ml-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition duration-300">No, Go Back</button>`
          );
          document.getElementById('confirmCancelBooking').onclick = () => updateBookingStatus(bookingId, 'cancelled');
        };
      });

      document.querySelectorAll('.complete-booking-btn').forEach(button => {
        button.onclick = (event) => {
          event.stopPropagation();
          const bookingId = event.currentTarget.dataset.id;
          showModal('Mark as Completed', `<p class="text-gray-700">Are you sure you want to mark this booking as completed? This will also make the assigned driver idle again.</p>`,
            `<button id="confirmCompleteBooking" data-id="${bookingId}" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-full transition duration-300">Yes, Complete</button>
             <button data-dismiss="modal" class="ml-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition duration-300">No, Go Back</button>`
          );
          document.getElementById('confirmCompleteBooking').onclick = async () => {
            const booking = allBookingsData[bookingId];
            if (booking && booking.assignedDriverId) {
              await updateDriverStatus(booking.assignedDriverId, 'idle');
            }
            updateBookingStatus(bookingId, 'completed');
          };
        };
      });
    };

    // Helper function to get idle drivers from Realtime Database
    const getIdleDrivers = async () => {
      const driversRef = ref(db, `/artifacts/${appId}/public/data/drivers`);
      const snapshot = await get(driversRef);
      const idleDrivers = [];
      if (snapshot.exists()) {
        const driversData = snapshot.val();
        Object.entries(driversData).forEach(([driverId, driver]) => {
          if (driver.status === 'idle' || driver.status === 'available') {
            idleDrivers.push({
              id: driverId,
              name: driver.driverName
            });
          }
        });
      }
      return idleDrivers;
    };

    // Tab switching logic
    const handleTabSwitch = (tabId) => {
      // Hide all content divs
      contentDashboard.classList.add('hidden');
      contentBookings.classList.add('hidden');
      contentDrivers.classList.add('hidden');
      contentFeedback.classList.add('hidden');

      // Remove active class from all tabs and update titles
      tabLinks.forEach(link => {
        link.classList.remove('tab-active', 'text-white', 'hover:bg-gray-100');
        link.classList.add('text-gray-600', 'hover:bg-gray-100');
        if (link.dataset.tab === tabId) {
          link.classList.add('tab-active');
          pageTitle.textContent = link.querySelector('span').textContent;
        }
      });

      // Show the selected content and activate the tab
      if (tabId === 'dashboard') {
        contentDashboard.classList.remove('hidden');
        renderDashboard();
      } else if (tabId === 'drivers') {
        contentDrivers.classList.remove('hidden');
        filterDrivers(lastDriverFilterStatus);
        updateDriverFilterButtonStyles(lastDriverFilterStatus);
      } else if (tabId === 'bookings') {
        contentBookings.classList.remove('hidden');
        filterBookings(lastBookingFilterStatus);
        updateBookingFilterButtonStyles(lastBookingFilterStatus);
      } else if (tabId === 'feedback') {
        contentFeedback.classList.remove('hidden');
        renderFeedback();
      }
      lucide.createIcons();
    };

    // Initial setup when the document is ready
    document.addEventListener('DOMContentLoaded', async () => {
      // Listen for auth state changes
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          userIdDisplay.textContent = `UID: ${userId}`;

          // Initialize Lucide icons after authentication
          lucide.createIcons();

          // Set initial view to Dashboard
          handleTabSwitch('dashboard');

          // Fetch initial data for all tabs
          await fetchDrivers();
          await fetchBookings();
          await fetchFeedback();

          // --- Attach Event Listeners after everything is ready ---
          // Event listeners for tabs
          tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              const tabId = link.dataset.tab;
              handleTabSwitch(tabId);
              // Close mobile sidebar if open
              sidebar.classList.remove('sidebar-open');
            });
          });

          // Filter button logic for drivers
          document.querySelectorAll('.filter-drivers-btn').forEach(button => {
            button.addEventListener('click', () => {
              const status = button.dataset.status;
              lastDriverFilterStatus = status; // Update last used filter
              filterDrivers(status);
              // Update active button styling
              updateDriverFilterButtonStyles(status);
            });
          });

          // Filter button logic for bookings
          document.querySelectorAll('.filter-bookings-btn').forEach(button => {
            button.addEventListener('click', () => {
              const status = button.dataset.status;
              lastBookingFilterStatus = status; // Update last used filter
              filterBookings(status);
              // Update active button styling
              updateBookingFilterButtonStyles(status);
            });
          });

          // Logout functionality
          logoutBtn.addEventListener('click', async () => {
            try {
              await signOut(auth);
            } catch (error) {
              console.error("Error signing out: ", error);
            }
          });

          // Event listener for the modal to close when clicking the backdrop
          modal.addEventListener('click', (event) => {
            if (event.target === modal || event.target.closest('[data-dismiss="modal"]')) {
              closeModal();
            }
          });

          // Mobile menu toggle
          mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('sidebar-open');
          });

          // Close mobile menu when clicking outside
          document.addEventListener('click', (event) => {
            const isClickInsideSidebar = sidebar.contains(event.target) || mobileMenuBtn.contains(event.target);
            if (!isClickInsideSidebar && sidebar.classList.contains('sidebar-open')) {
              sidebar.classList.remove('sidebar-open');
            }
          });

        } else {
          console.log("User is signed out.");
          // You might want to handle the signed out state here, e.g., show a login screen
        }
      });
      // Initial app authentication process
      await setupApp();
    });
  </script>
</body>

</html>
